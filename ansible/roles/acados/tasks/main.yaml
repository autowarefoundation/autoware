---
# Pre-build acados and t_renderer for autoware_path_optimizer.
# Run after vcs import (so universe/external/acados and tera_renderer exist)
# and after the rust role (for cargo to build t_renderer).

- name: Check if acados source exists
  ansible.builtin.stat:
    path: "{{ acados_source_dir }}/CMakeLists.txt"
  register: acados_src

- name: Fail when acados source missing
  ansible.builtin.fail:
    msg: "acados source not found at {{ acados_source_dir }}. Run: vcs import src < repositories/autoware.repos --recursive"
  when: not acados_src.stat.exists

# --- Build acados ---
- name: Create acados build directory
  ansible.builtin.file:
    path: "{{ acados_build_dir }}"
    state: directory
    mode: "0755"

- name: Configure acados with CMake
  become: false
  ansible.builtin.command:
    cmd: >
      cmake -S {{ acados_source_dir }}
            -B {{ acados_build_dir }}
            -DCMAKE_INSTALL_PREFIX={{ acados_install_dir }}
            -DCMAKE_BUILD_TYPE=Release
            -DACADOS_WITH_QPOASES=ON
            -DBUILD_SHARED_LIBS=OFF
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON
  register: acados_configure
  changed_when: acados_configure.rc == 0

- name: Build acados
  become: false
  ansible.builtin.command:
    cmd: cmake --build {{ acados_build_dir }} --config Release
  register: acados_build
  changed_when: acados_build.rc == 0

- name: Install acados
  become: false
  ansible.builtin.command:
    cmd: cmake --build {{ acados_build_dir }} --config Release --target install
  register: acados_install
  changed_when: acados_install.rc == 0

# --- Build t_renderer ---
- name: Check if tera_renderer source exists
  ansible.builtin.stat:
    path: "{{ tera_renderer_source_dir }}/Cargo.toml"
  register: tera_renderer_src

- name: Build t_renderer with cargo
  become: false
  ansible.builtin.command:
    cmd: cargo build --release
  args:
    chdir: "{{ tera_renderer_source_dir }}"
  environment:
    PATH: "{{ ansible_env.HOME }}/.cargo/bin:{{ ansible_env.PATH }}"
  register: cargo_build
  changed_when: cargo_build.rc == 0
  when: tera_renderer_src.stat.exists

- name: Create acados bin directory for t_renderer
  ansible.builtin.file:
    path: "{{ acados_source_dir }}/bin"
    state: directory
    mode: "0755"
  when: tera_renderer_src.stat.exists

- name: Copy t_renderer into acados bin
  become: false
  ansible.builtin.copy:
    src: "{{ tera_renderer_source_dir }}/target/release/t_renderer"
    dest: "{{ t_renderer_output_path }}"
    mode: "0755"
    remote_src: true
  when: tera_renderer_src.stat.exists

- name: Warn if tera_renderer was not built
  ansible.builtin.debug:
    msg: "tera_renderer source not found at {{ tera_renderer_source_dir }}; t_renderer was not built. path_optimizer will need it at build time."
  when: not tera_renderer_src.stat.exists
