# Remove legacy agnocast PPA configuration (if exists)
- name: Remove legacy agnocast PPA via add-apt-repository
  ansible.builtin.command: add-apt-repository --remove ppa:t4-system-software/agnocast -y
  register: agnocast_legacy_ppa_remove
  failed_when: false
  changed_when: agnocast_legacy_ppa_remove.rc == 0
  become: true

- name: Remove legacy agnocast sources.list files
  ansible.builtin.shell: rm -f /etc/apt/sources.list.d/*agnocast*.list
  args:
    executable: /bin/bash
  register: agnocast_legacy_sources_remove
  changed_when: false
  become: true

- name: Remove legacy agnocast GPG keys from trusted.gpg.d
  ansible.builtin.shell: rm -f /etc/apt/trusted.gpg.d/*agnocast*.gpg
  args:
    executable: /bin/bash
  register: agnocast_legacy_gpg_remove
  changed_when: false
  become: true

# TODO(rej55, sykwer): IPv6 support
- name: Save current IPv6 settings
  ansible.builtin.shell: |
    sysctl net.ipv6.conf.all.disable_ipv6
    sysctl net.ipv6.conf.default.disable_ipv6
  register: agnocast_ipv6_settings
  changed_when: false
  become: true

- name: Temporarily disable IPv6
  ansible.posix.sysctl:
    name: "{{ item.name }}"
    value: 1
    sysctl_set: true
    state: present
  loop:
    - { name: net.ipv6.conf.all.disable_ipv6 }
    - { name: net.ipv6.conf.default.disable_ipv6 }
  become: true

- name: Create /etc/apt/keyrings directory
  ansible.builtin.file:
    path: /etc/apt/keyrings
    state: directory
    mode: "0755"
  become: true

- name: Download agnocast PPA GPG key while IPv6 is disabled
  ansible.builtin.get_url:
    url: https://keyserver.ubuntu.com/pks/lookup?op=get&search=0xCFDB1950382092423DF37D3E075CD8B5C91E5ACA
    dest: /tmp/agnocast-ppa.asc
    mode: "0644"
  become: true
  register: agnocast_gpg_key_download

- name: Convert GPG key to binary format and install
  ansible.builtin.shell: |
    gpg --dearmor < /tmp/agnocast-ppa.asc > /etc/apt/keyrings/agnocast-ppa.gpg
    chmod 0644 /etc/apt/keyrings/agnocast-ppa.gpg
  args:
    creates: /etc/apt/keyrings/agnocast-ppa.gpg
  become: true

- name: Remove temporary GPG key file
  ansible.builtin.file:
    path: /tmp/agnocast-ppa.asc
    state: absent
  become: true

- name: Verify GPG key fingerprint
  ansible.builtin.shell: |
    set -o pipefail
    gpg --show-keys /etc/apt/keyrings/agnocast-ppa.gpg | grep -q 'CFDB1950382092423DF37D3E075CD8B5C91E5ACA'
  args:
    executable: /bin/bash
  register: agnocast_gpg_verify
  failed_when: agnocast_gpg_verify.rc != 0
  changed_when: false

- name: Display GPG key verification success
  ansible.builtin.debug:
    msg: "GPG key fingerprint verified successfully: CFDB1950382092423DF37D3E075CD8B5C91E5ACA"

- name: Add agnocast repository
  ansible.builtin.copy:
    dest: /etc/apt/sources.list.d/agnocast.sources
    content: |
      Types: deb
      URIs: http://ppa.launchpad.net/t4-system-software/agnocast/ubuntu
      Suites: jammy
      Components: main
      Signed-By: /etc/apt/keyrings/agnocast-ppa.gpg
    mode: "0644"
  become: true

- name: Restore original IPv6 settings # noqa: no-changed-when
  ansible.posix.sysctl:
    name: "{{ item.split('=')[0] | trim }}"
    value: 0
    sysctl_set: true
    state: present
  loop: "{{ agnocast_ipv6_settings.stdout_lines }}"
  when: item is search('=\\s*0')
  become: true

- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
  become: true

- name: Install {{ agnocast_heaphook_package }}
  ansible.builtin.apt:
    name: "{{ agnocast_heaphook_package }}"
    state: present
  become: true

# Detect container environment
- name: Check if running in a container using systemd-detect-virt
  ansible.builtin.command: systemd-detect-virt -c
  register: agnocast_container_detection
  failed_when: false
  changed_when: false

- name: Set container environment fact
  ansible.builtin.set_fact:
    agnocast_is_container: "{{ agnocast_container_detection.rc == 0 }}"

- name: Display environment detection result
  ansible.builtin.debug:
    msg: "Running in container: {{ agnocast_is_container }} (detected: {{ agnocast_container_detection.stdout | default('none') }})"

- name: Display info when skipping agnocast-kmod in container
  ansible.builtin.debug:
    msg: "WARNING: Running in container environment. Skipping agnocast-kmod installation. Please ensure agnocast-kmod is installed on the host system for proper functionality of agnocast."
  when: agnocast_is_container

- name: Handle kernel-related tasks (headers + kmod, non-container only)
  when: not agnocast_is_container
  block:
    - name: Check if linux-headers package is available
      ansible.builtin.shell: |
        set -o pipefail
        apt-cache search ^linux-headers-{{ ansible_kernel }}$ | grep -q linux-headers-{{ ansible_kernel }}
      args:
        executable: /bin/bash
      register: agnocast_linux_headers_available
      failed_when: false
      changed_when: false
      become: true

    - name: Display warning if linux-headers is not available
      ansible.builtin.debug:
        msg: "WARNING: linux-headers-{{ ansible_kernel }} package not found. The agnocast-kmod installation may fail. Please manually install the kernel headers and re-run this role."
      when: agnocast_linux_headers_available.rc != 0

    - name: Install linux headers for the running kernel
      ansible.builtin.apt:
        name: linux-headers-{{ ansible_kernel }}
        state: present
      register: agnocast_linux_headers_install
      ignore_errors: true
      become: true
      when: agnocast_linux_headers_available.rc == 0

    - name: Display warning if linux-headers installation failed
      ansible.builtin.debug:
        msg: "WARNING: linux-headers-{{ ansible_kernel }} installation failed. DKMS installation may also fail."
      when:
        - agnocast_linux_headers_available.rc == 0
        - agnocast_linux_headers_install.failed | default(false)

    - name: Check if agnocast-kmod is installed in dkms with version v{{ agnocast_version }} # noqa: risky-shell-pipe
      ansible.builtin.shell: dkms status agnocast/{{ agnocast_version }} | grep -q 'installed'
      register: agnocast_dkms_status
      failed_when: false
      changed_when: false

    - name: Purge agnocast-kmod if not found in dkms for version v{{ agnocast_version }}
      ansible.builtin.apt:
        name: "{{ agnocast_kmod_package }}"
        state: absent
      become: true
      when: agnocast_dkms_status.rc != 0

    - name: Install agnocast-kmod if not found in dkms for version v{{ agnocast_version }}
      ansible.builtin.apt:
        name: "{{ agnocast_kmod_package }}"
        state: present
      register: agnocast_kmod_install
      ignore_errors: true
      become: true
      when: agnocast_dkms_status.rc != 0

    - name: Display warning if agnocast-kmod installation failed
      ansible.builtin.debug:
        msg: "WARNING: agnocast-kmod installation failed. To use agnocast, please manually download the Linux kernel headers and re-run this script."
      when:
        - agnocast_dkms_status.rc != 0
        - agnocast_kmod_install.failed | default(false)

    - name: Ensure agnocast module is loaded at boot via modules-load.d
      ansible.builtin.copy:
        dest: /etc/modules-load.d/agnocast.conf
        content: "agnocast\n"
        owner: root
        group: root
        mode: "0644"
      become: true
