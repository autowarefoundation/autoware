name: scenario-test

on:
  workflow_dispatch:

jobs:
  scenario-test:
    runs-on: ubuntu-22.04
    container: ghcr.io/autowarefoundation/autoware:universe-devel

    env:
      ROS_DISTRO: humble
      GH_TOKEN: ${{ secrets.GH_TOKEN }}

    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Free disk space
        run: |
          sudo rm -rf /usr/local/lib/android /opt/ghc /opt/hostedtoolcache /usr/share/dotnet /opt/google /usr/lib/jvm

      - name: Install required packages
        run: |
          apt-get update && apt-get install -y \
            unzip \
            curl \
            gnupg2 \
            lsb-release \
            python3-pip \
            git \
            ros-humble-pcl-ros \
            qtbase5-dev \
            python3-vcstool \
            ros-humble-tinyxml2-vendor
          pip3 install --upgrade gdown

      - name: Setup Autoware workspace
        run: |
          mkdir -p ~/autoware_ws/src
          cd ~/autoware_ws
          git clone https://github.com/autowarefoundation/autoware.git src/autoware
          cd src
          vcs import < autoware/autoware.repos

      - name: Manually add missing dependencies (e.g., tier4_external_api_msgs)
        run: |
          cd ~/autoware_ws/src
          git clone https://${GH_TOKEN}@github.com/tier4/tier4_external_api_msgs.git

      - name: Install ROS dependencies
        run: |
          source /opt/ros/${ROS_DISTRO}/setup.bash
          cd ~/autoware_ws
          rosdep update
          rosdep install -y --from-paths src --ignore-src --rosdistro ${ROS_DISTRO}

      - name: Build Autoware
        run: |
          cd ~/autoware_ws
          source /opt/ros/${ROS_DISTRO}/setup.bash
          colcon build --symlink-install --cmake-args -DCMAKE_BUILD_TYPE=Release
          source install/setup.bash

      - name: Download sample scenario
        run: |
          mkdir -p ~/data/scenarios
          curl -L -o ~/data/scenarios/sample-scenario.yaml https://example.com/sample-scenario.yaml

      - name: Download sample map-planning
        run: |
          mkdir -p ~/data/maps
          curl -L -o ~/data/maps/sample-map-planning.zip https://example.com/sample-map.zip
          unzip ~/data/maps/sample-map-planning.zip -d ~/data/maps/

      - name: Fix path in scenario file
        run: |
          sed -i 's|PATH_TO_MAP|/home/runner/data/maps/sample-map-planning|g' ~/data/scenarios/sample-scenario.yaml

      - name: Run scenario_test_runner
        run: |
          source /opt/ros/${ROS_DISTRO}/setup.bash
          source ~/autoware_ws/install/setup.bash
          ros2 launch scenario_test_runner scenario_test_runner.launch.xml scenario:=/home/runner/data/scenarios/sample-scenario.yaml

