name: scenario-test
on:
  workflow_dispatch:

jobs:
  scenario-test:
    runs-on: ubuntu-24.04
    container: ghcr.io/autowarefoundation/autoware:universe-devel
    steps:
      - name: Check out repository
        uses: actions/checkout@v4

      - name: Free disk space
        uses: ./.github/actions/free-disk-space

      - name: Install required packages
        run: |
          sudo apt-get update
          sudo apt-get install -y --fix-missing unzip curl gnupg2 lsb-release python3-pip git ros-humble-pcl-ros
          sudo apt-get autoremove -y
          sudo apt-get clean
          pip install --upgrade gdown vcstool
        shell: bash

      - name: Clone Autoware and Import simulator.repos
        run: |
          mkdir -p ~/autoware_ws/src
          cd ~/autoware_ws
          git clone --recurse-submodules https://github.com/autowarefoundation/autoware.git src/autoware
          cd src
          vcs import < autoware/simulator.repos
        shell: bash

      - name: Install ROS dependencies
        run: |
          cd ~/autoware_ws
          rosdep update
          rosdep install --from-paths src --ignore-src -r -y
        shell: bash

      - name: Patch entity_status.cpp
        run: |
          echo "Applying fix to entity_status.cpp..."
          ENTITY_STATUS_FILE=~/autoware_ws/src/simulator/scenario_simulator/simulation/traffic_simulator/src/data_type/entity_status.cpp
          if [ -f "$ENTITY_STATUS_FILE" ]; then
            sed -i 's/assert(entity_status_.lanelet_pose_valid == canonicalized_lanelet_pose_.has_value());/entity_status_.lanelet_pose_valid = canonicalized_lanelet_pose_.has_value();/' "$ENTITY_STATUS_FILE"
            echo "Patch applied successfully."
          else
            echo "ERROR: entity_status.cpp not found!"
            exit 1
          fi
        shell: bash

      - name: Build Autoware (after patching)
        run: |
          cd ~/autoware_ws
          source /opt/ros/humble/setup.bash
          source /opt/autoware/setup.bash
          colcon build --symlink-install --packages-select traffic_simulator
          source install/setup.bash
        shell: bash

      - name: Cleanup logs and reset ROS
        run: |
          echo "Cleaning up ROS logs and resetting environment..."
          source ~/autoware_ws/install/setup.bash
          ros2 daemon stop || true
          ros2 daemon start
          rm -rf ~/.ros/log/*
        shell: bash

      - name: Download scenario file
        run: |
          SCENARIO_FILE="./sample-scenario.yaml"
          if [ ! -f "$SCENARIO_FILE" ]; then
            echo "Downloading sample scenario file..."
            wget -O sample-scenario.yaml https://drive.google.com/uc?id=1Tq7snfDPsuPHPtl50aL5fJY6paiC-HxV
          fi
          ls -l sample-scenario.yaml || { echo "ERROR: sample-scenario.yaml is missing!"; exit 1; }
        shell: bash

      - name: Download sample-map-planning maps
        run: |
          gdown --id 1499_nsbUbIeturZaDj7jhUownh5fvXHd -O sample-map-planning.zip
          mkdir -p /home/user/autoware_map
          unzip sample-map-planning.zip -d /home/user/autoware_map
        shell: bash

      - name: Debug ROS 2 Context
        run: |
          source ~/autoware_ws/install/setup.bash
          echo "Checking running ROS 2 nodes..."
          ros2 node list || echo "No ROS2 nodes found!"
          echo "Checking running ROS 2 topics..."
          ros2 topic list || echo "No ROS2 topics found!"
        shell: bash

      - name: Launch scenario_test_runner
        run: |
          SCENARIO_FILE="./sample-scenario.yaml"
          source ~/autoware_ws/install/setup.bash
          if [ -f "$SCENARIO_FILE" ]; then
            echo "Launching scenario_test_runner..."
            ros2 launch scenario_test_runner scenario_test_runner.launch.py \
              architecture_type:=awf/universe/20250130 \
              record:=true \
              scenario:="$SCENARIO_FILE" \
              sensor_model:=sample_sensor_kit \
              vehicle_model:=sample_vehicle \
              initialize_duration:=100 \
              output_directory:=./results 2>&1 | tee scenario_output.log || true
          else
            echo "ERROR: sample-scenario.yaml is missing!"
            exit 1
          fi
        shell: bash
